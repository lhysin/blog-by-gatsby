---
title: "Aws S3와 캐시, 미리보기와 다운로드"
date: "2019-11-22"
category: Issue
tags:
  - AWS
  - S3
---


>AWS S3를 사용하여 파일 업/다운로드를 서비스하는 화면에서 발생한 이슈에 대하여 작성한다.

<br/>
<br/>

### S3 업로드 환경
&nbsp;&nbsp;&nbsp;&nbsp;WAS의 사양이 높지 않은 환경이라 클라이언트에서 직접 S3에 억세스를 하기로   
협의가 이뤄지었고 이를 위해 [Presigned URLs](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-presigned-urls.html)를 이용하였다.

&nbsp;&nbsp;&nbsp;&nbsp;클라이언트에서 선택된 파일 정보를 서버에 요청한 뒤 서버에서는 서버에 셋팅된 AWS Access Key를 활용하여 셋팅된 Presigned Url을 생성하고 클라이언트는 URL로 실제 파일 업로드를 행한다. 업로드 할때 `Axios`를 사용하였으며 구현코드는 아래와같다.

```js
axios.put(presignedUrl, file,
    {
        headers: {
            'Content-Type': file.type
            ,'Access-Control-Allow-Origin' : '*'
            ,'Access-Control-Allow-Methods' : 'GET, POST, OPTIONS, PUT, DELETE'
        }

        ,timeout : 3600 * 1000 * 10
        ,withCredentials : false
    }
).then( res => {...})
````

&nbsp;&nbsp;&nbsp;&nbsp;S3에 업로드된 파일을 활용하는 클라이언트와의 `CORS` 이슈를 해결하기위해  업로드시 `Access-Control-Allow`값을 요청헤더에 담았다. 추가적으로 S3에서도 CORS 이슈 해결을 위해서는 S3에서의 설정 또한 필요하며 [API_PutBucketCors](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/API/API_PutBucketCors.html)에서 확인 가능하다.
  
S3 설정 예시
```xml
PUT /?cors HTTP/1.1
Host: Bucket.s3.amazonaws.com
Content-MD5: ContentMD5
<?xml version="1.0" encoding="UTF-8"?>
<CORSConfiguration xmlns="http://s3.amazonaws.com/doc/2006-03-01/">
   <CORSRule>
      <AllowedHeader>string</AllowedHeader>
      ...
      <AllowedMethod>string</AllowedMethod>
      ...
      <AllowedOrigin>string</AllowedOrigin>
      ...
      <ExposeHeader>string</ExposeHeader>
      ...
      <MaxAgeSeconds>integer</MaxAgeSeconds>
   </CORSRule>
   ...
</CORSConfiguration>
```
<br/>
<br/>
### S3와 로컬 캐시

&nbsp;&nbsp;&nbsp;&nbsp;여기까지만 해도 파일업로드, 업로드된 파일 미리보기, 다운로드시 특별한 이슈가 없었으나... 파일 미리보기후 다운로드가 안된다는 이슈가 발생하였다.

&nbsp;&nbsp;&nbsp;&nbsp;업로드된 해당 파일은 HTML파일이었으며 동일파일의 미리보기를 지원하는 페이지였다. HTML 파일 미리보기 기능의 경우 내부 보안 정책상 업로드된 링크를 새창으로 오픈해주는 역할뿐이다. 또한 파일 다운로드시에는 업로드된 파일을 브라우져가 READ하여 파일명을 새로이 할당하여 다운로드를 지속시켜준다,

&nbsp;&nbsp;&nbsp;&nbsp;하지만 미리보기시 CORS 허용이 적용될 필요가 없는 새창에서 오픈되면서 해당파일이 브라우져 `disk cache`로 저장되어 응답헤더 정보 또한 캐쉬화 되어 저장된 상태에서 파일을 다운로드시 CORS 허가 내용이 없는 상태의 캐쉬된 파일을 브라우저가 읽게되어 CORS 이슈가 발생되어 다운로드가 실패하는 케이스였다.
  
정리하면

1. S3 CORS 허가 설정 셋팅
2. Presigned URL을 통해 클라이언트 파일 업로드
3. 업로드된 파일을 클라이언트와 무관한 새탭에서 오픈(CORS 무관)
4. 캐쉬화된 파일의 CORS 충돌

<br/>
<br/>

### 이슈 해결
&nbsp;&nbsp;&nbsp;&nbsp;현 상황에서의 해결책은 업로드된 파일의 캐쉬가 걸리지 않게 결과적으로 업로드된 파일을 브라우져가 로컬 캐쉬화 하지못하게 막는 방법을 생각하였고 클라이언트에서 S3서버로 업로드시 요청헤더가 값을 추가하였다.

```js {5}
axios.put(presignedUrl, file,
    {
        headers: {
            'Content-Type': file.type
            ,'Cache-Control': 'no-cache'
            ,'Access-Control-Allow-Origin' : '*'
            ,'Access-Control-Allow-Methods' : 'GET, POST, OPTIONS, PUT, DELETE'
        }

        ,timeout : 3600 * 1000 * 10
        ,withCredentials : false
    }
).then( res => {...})
````

&nbsp;&nbsp;&nbsp;&nbsp;`Cache-Control` 값을 `no-cache`로 할당하여 브라우져가 `disk cache`로 저장 하지 않게 명시적으로 하여 해당 이슈는 해결되었다.
